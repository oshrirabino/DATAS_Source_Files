<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Visualization</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Tree Visualization</h1>
            <div class="status">
                <span id="connection-status">Disconnected</span>
            </div>
        </header>
        
        <main>
            <div class="controls">
                <div class="tree-type-selection">
                    <label for="tree-type">Tree Type:</label>
                    <select id="tree-type">
                        <option value="btree">B-Tree</option>
                        <option value="avltree">AVL Tree</option>
                    </select>
                </div>
                <button id="connect-btn">Connect</button>
                <button id="disconnect-btn" disabled>Disconnect</button>
            </div>
            
            <div class="tree-operations">
                <h3>Tree Operations</h3>
                <div class="operation-group">
                    <div class="operation-item">
                        <label for="insert-value">Insert:</label>
                        <input type="number" id="insert-value" placeholder="Enter integer" disabled>
                        <button id="insert-btn" disabled>Insert</button>
                    </div>
                    <div class="operation-item">
                        <label for="remove-value">Remove:</label>
                        <input type="number" id="remove-value" placeholder="Enter integer" disabled>
                        <button id="remove-btn" disabled>Remove</button>
                    </div>
                    <div class="operation-item">
                        <label for="find-value">Find:</label>
                        <input type="number" id="find-value" placeholder="Enter integer" disabled>
                        <button id="find-btn" disabled>Find</button>
                    </div>
                </div>
                <div class="utility-buttons">
                    <button id="clear-logs-btn">Clear Logs</button>
                    <button id="play-animation-btn" disabled>Play Animation</button>
                    <button id="pause-animation-btn" disabled>Pause</button>
                    <button id="reset-tree-btn" disabled>Reset Tree</button>
                </div>
            </div>
            
            <div class="tree-container">
                <div id="tree-display">
                    <p>Tree visualization will appear here</p>
                </div>
            </div>
            
            <div class="logs">
                <h3>Server Messages</h3>
                <div id="log-output"></div>
            </div>
        </main>
    </div>
    
    <script src="js/communication.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/parserBTree.js"></script>
    <script src="js/parserAVLTree.js"></script>
    <script src="js/animation.js"></script>
    <script>
        // Initialize the application
        
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const statusSpan = document.getElementById('connection-status');
            const logOutput = document.getElementById('log-output');
            
            // Connect button handler
            connectBtn.addEventListener('click', function() {
                if (window.treeCommunication) {
                    const treeType = document.getElementById('tree-type').value;
                    window.treeCommunication.connect('/session', treeType);
                }
            });
            
            // Disconnect button handler
            disconnectBtn.addEventListener('click', function() {
                if (window.treeCommunication) {
                    window.treeCommunication.disconnect();
                }
            });
            
            // Update UI based on connection status
            function updateConnectionStatus(connected) {
                if (connected) {
                    statusSpan.textContent = 'Connected';
                    statusSpan.className = 'connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                } else {
                    statusSpan.textContent = 'Disconnected';
                    statusSpan.className = 'disconnected';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                }
            }
            
            // Log message to UI
            function logToUI(message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            // Test if classes are available
            console.log('Checking parser classes...');
            console.log('BTreeParser available:', typeof BTreeParser);
            console.log('AVLTreeParser available:', typeof AVLTreeParser);
            console.log('TreeAnimator available:', typeof TreeAnimator);
            
            // Initialize parsers and animation system
            try {
                console.log('Initializing tree system...');
                
                // Initialize parsers
                window.btreeParser = new BTreeParser();
                window.avlParser = new AVLTreeParser();
                
                // Initialize animator
                window.treeAnimator = new TreeAnimator('tree-display');
                
                // Initialize log accumulator
                window.logAccumulator = {
                    logs: [],
                    currentTreeType: 'btree',
                    snapshots: [],
                    currentSnapshotIndex: 0,
                    
                    addLog: function(logMessage) {
                        this.logs.push(logMessage);
                        console.log('Added log:', logMessage);
                    },
                    
                    parseLogs: function() {
                        // Parse only the latest log line incrementally
                        if (this.logs.length === 0) {
                            return [];
                        }
                        
                        const latestLog = this.logs[this.logs.length - 1];
                        console.log('Parsing latest log incrementally:', latestLog);
                        
                        let newSnapshot;
                        if (this.currentTreeType === 'btree') {
                            newSnapshot = window.btreeParser.parseLogLineIncremental(latestLog);
                        } else {
                            newSnapshot = window.avlParser.parseLogLineIncremental(latestLog);
                        }
                        
                        if (newSnapshot) {
                            this.snapshots.push(newSnapshot);
                            this.currentSnapshotIndex = this.snapshots.length - 1;
                            console.log('Created new snapshot:', newSnapshot.operation);
                        }
                        
                        console.log('Total snapshots:', this.snapshots.length);
                        return this.snapshots;
                    },
                    
                    setTreeType: function(treeType) {
                        this.currentTreeType = treeType;
                        this.logs = []; // Clear logs when switching tree types
                        this.snapshots = [];
                        this.currentSnapshotIndex = 0;
                        
                        // Reset parsers when switching tree types
                        if (window.btreeParser) {
                            window.btreeParser.reset();
                        }
                        if (window.avlParser) {
                            window.avlParser.reset();
                        }
                        
                        console.log('Switched to tree type:', treeType);
                    },
                    
                    getCurrentSnapshot: function() {
                        if (this.snapshots.length === 0) return null;
                        return this.snapshots[this.currentSnapshotIndex];
                    },
                    
                    nextSnapshot: function() {
                        if (this.currentSnapshotIndex < this.snapshots.length - 1) {
                            this.currentSnapshotIndex++;
                            return this.snapshots[this.currentSnapshotIndex];
                        }
                        return null;
                    }
                };
                
                console.log('Tree system initialized successfully');
                
            } catch (error) {
                console.error('Tree system failed to initialize:', error);
                console.error('Error stack:', error.stack);
            }
            
            // Initialize communication module
            window.treeCommunication = new TreeCommunication({
                onConnect: () => {
                    updateConnectionStatus(true);
                    if (window.treeUI) {
                        window.treeUI.setConnectionStatus(true);
                    }
                },
                onDisconnect: () => {
                    updateConnectionStatus(false);
                    if (window.treeUI) {
                        window.treeUI.setConnectionStatus(false);
                    }
                },
                onMessage: (data) => {
                    // Log to console for debugging
                    console.log('Received message:', data);
                    logToUI(JSON.stringify(data));
                },
                onAnimationData: (data) => {
                    // Process log messages through parsers
                    if (data.type === 'log') {
                        console.log('Processing log message:', data.message);
                        
                        // Add log to accumulator
                        if (window.logAccumulator) {
                            window.logAccumulator.addLog(data.message);
                            
                            // Parse logs and update animation
                            const snapshots = window.logAccumulator.parseLogs();
                            console.log('Parsed snapshots:', snapshots.length);
                            
                            if (snapshots.length > 0) {
                                const currentSnapshot = window.logAccumulator.getCurrentSnapshot();
                                
                                if (currentSnapshot && window.treeAnimator) {
                                    try {
                                        window.treeAnimator.renderSnapshot(currentSnapshot, window.logAccumulator.currentTreeType);
                                        console.log('Snapshot rendered:', currentSnapshot.operation);
                                    } catch (error) {
                                        console.error('Error rendering snapshot:', error);
                                    }
                                }
                                
                                // Enable animation controls
                                const playBtn = document.getElementById('play-animation-btn');
                                const resetBtn = document.getElementById('reset-tree-btn');
                                if (playBtn) playBtn.disabled = false;
                                if (resetBtn) resetBtn.disabled = false;
                            } else {
                                // Debug: Show what logs we have
                                console.log('No snapshots created. Current logs:');
                                window.logAccumulator.logs.forEach((log, i) => {
                                    console.log(`  ${i + 1}: ${log}`);
                                });
                            }
                        }
                    } else if (data.type === 'program') {
                        // Handle program messages (like status updates)
                        console.log('Program message:', data.message);
                    }
                },
                onError: (error) => {
                    console.error('Connection error:', error);
                    logToUI('Error: ' + error.message);
                }
            });
            
            // Initialize UI module
            window.treeUI = new TreeUI(window.treeCommunication);
            
            // Initialize animation controls
            const playBtn = document.getElementById('play-animation-btn');
            const pauseBtn = document.getElementById('pause-animation-btn');
            const resetBtn = document.getElementById('reset-tree-btn');
            
            let animationInterval = null;
            let isAnimating = false;
            
            // Play animation handler
            if (playBtn) {
                playBtn.addEventListener('click', function() {
                    if (window.logAccumulator && window.logAccumulator.snapshots.length > 0) {
                        isAnimating = true;
                        playBtn.disabled = true;
                        pauseBtn.disabled = false;
                        
                        // Start animation from current snapshot
                        let currentIndex = window.logAccumulator.currentSnapshotIndex;
                        const snapshots = window.logAccumulator.snapshots;
                        
                        animationInterval = setInterval(() => {
                            if (currentIndex < snapshots.length) {
                                const snapshot = snapshots[currentIndex];
                                if (window.treeAnimator) {
                                    window.treeAnimator.renderSnapshot(snapshot, window.logAccumulator.currentTreeType);
                                }
                                currentIndex++;
                            } else {
                                // Animation complete
                                clearInterval(animationInterval);
                                isAnimating = false;
                                playBtn.disabled = false;
                                pauseBtn.disabled = true;
                            }
                        }, 1000); // 1 second per snapshot
                    }
                });
            }
            
            // Pause animation handler
            if (pauseBtn) {
                pauseBtn.addEventListener('click', function() {
                    if (animationInterval) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                    }
                    isAnimating = false;
                    playBtn.disabled = false;
                    pauseBtn.disabled = true;
                });
            }
            
            // Reset tree handler
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (window.logAccumulator) {
                        window.logAccumulator.logs = [];
                        window.logAccumulator.snapshots = [];
                        window.logAccumulator.currentSnapshotIndex = 0;
                    }
                    if (window.treeAnimator) {
                        window.treeAnimator.clearDisplay();
                    }
                    if (animationInterval) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                    }
                    isAnimating = false;
                    playBtn.disabled = true;
                    pauseBtn.disabled = true;
                });
            }
            
            // Update system when tree type changes
            const treeTypeSelect = document.getElementById('tree-type');
            if (treeTypeSelect) {
                treeTypeSelect.addEventListener('change', function() {
                    const treeType = this.value;
                    console.log('Tree type changed to:', treeType);
                    
                    // Update log accumulator
                    if (window.logAccumulator) {
                        window.logAccumulator.setTreeType(treeType);
                    }
                    
                    // Clear the tree display
                    if (window.treeAnimator) {
                        window.treeAnimator.clearDisplay();
                    }
                });
            }
            
        });
    </script>
</body>
</html>

