<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Visualization</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Tree Visualization</h1>
            <div class="status">
                <span id="connection-status">Disconnected</span>
            </div>
        </header>
        
        <main>
            <div class="controls">
                <div class="tree-type-selection">
                    <label for="tree-type">Tree Type:</label>
                    <select id="tree-type">
                        <option value="btree">B-Tree</option>
                        <option value="avltree">AVL Tree</option>
                    </select>
                </div>
                <button id="connect-btn">Connect</button>
                <button id="disconnect-btn" disabled>Disconnect</button>
            </div>
            
            <div class="tree-operations">
                <h3>Tree Operations</h3>
                <div class="operation-group">
                    <div class="operation-item">
                        <label for="insert-value">Insert:</label>
                        <input type="number" id="insert-value" placeholder="Enter integer" disabled>
                        <button id="insert-btn" disabled>Insert</button>
                    </div>
                    <div class="operation-item">
                        <label for="remove-value">Remove:</label>
                        <input type="number" id="remove-value" placeholder="Enter integer" disabled>
                        <button id="remove-btn" disabled>Remove</button>
                    </div>
                    <div class="operation-item">
                        <label for="find-value">Find:</label>
                        <input type="number" id="find-value" placeholder="Enter integer" disabled>
                        <button id="find-btn" disabled>Find</button>
                    </div>
                </div>
                <div class="utility-buttons">
                    <button id="print-btn" disabled>Print Tree</button>
                    <button id="clear-logs-btn">Clear Logs</button>
                    <button id="test-animation-btn">Test Animation</button>
                </div>
            </div>
            
            <div class="tree-container">
                <div id="tree-display">
                    <p>Tree visualization will appear here</p>
                </div>
            </div>
            
            <div class="logs">
                <h3>Server Messages</h3>
                <div id="log-output"></div>
            </div>
        </main>
    </div>
    
    <script src="js/communication.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/parserBTree.js"></script>
    <script src="js/parserAVLTree.js"></script>
    <script src="js/animation.js"></script>
    <script>
        // Test if JavaScript is working
        console.log('JavaScript is running!');
        console.log('Script tag reached!');
        
        // Test basic functionality
        try {
            console.log('Testing basic functionality...');
            const testDiv = document.createElement('div');
            testDiv.textContent = 'JS Test';
            testDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 5px; z-index: 9999;';
            document.body.appendChild(testDiv);
            setTimeout(() => {
                if (testDiv.parentNode) {
                    testDiv.parentNode.removeChild(testDiv);
                }
            }, 2000);
            console.log('Basic functionality test completed');
        } catch (error) {
            console.error('Basic functionality test failed:', error);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded!');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const statusSpan = document.getElementById('connection-status');
            const logOutput = document.getElementById('log-output');
            
            // Connect button handler
            connectBtn.addEventListener('click', function() {
                if (window.treeCommunication) {
                    const treeType = document.getElementById('tree-type').value;
                    window.treeCommunication.connect('/session', treeType);
                }
            });
            
            // Disconnect button handler
            disconnectBtn.addEventListener('click', function() {
                if (window.treeCommunication) {
                    window.treeCommunication.disconnect();
                }
            });
            
            // Update UI based on connection status
            function updateConnectionStatus(connected) {
                if (connected) {
                    statusSpan.textContent = 'Connected';
                    statusSpan.className = 'connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                } else {
                    statusSpan.textContent = 'Disconnected';
                    statusSpan.className = 'disconnected';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                }
            }
            
            // Log message to UI
            function logToUI(message) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            // Initialize animation module
            console.log('=== ANIMATION INITIALIZATION START ===');
            console.log('Initializing animation module...');
            console.log('BTreeParser available:', typeof BTreeParser);
            console.log('AVLTreeParser available:', typeof AVLTreeParser);
            console.log('TreeAnimation available:', typeof TreeAnimation);
            
            // Check if classes are actually defined
            if (typeof BTreeParser === 'undefined') {
                console.error('BTreeParser is undefined!');
            }
            if (typeof AVLTreeParser === 'undefined') {
                console.error('AVLTreeParser is undefined!');
            }
            if (typeof TreeAnimation === 'undefined') {
                console.error('TreeAnimation is undefined!');
            }
            
            // Check if container exists
            const container = document.getElementById('tree-display');
            console.log('Tree display container found:', container);
            
            if (!container) {
                console.error('Tree display container not found!');
                return;
            }
            
            try {
                window.treeAnimation = new TreeAnimation('tree-display', 'btree');
                console.log('Animation module initialized successfully:', window.treeAnimation);
                
                // Test the animation system immediately
                console.log('Testing animation system...');
                window.treeAnimation.showCaption('Animation system is working!');
                
                // Also test with a simple direct approach
                console.log('Testing direct caption creation...');
                const testCaption = document.createElement('div');
                testCaption.textContent = 'DIRECT TEST - This should be visible!';
                testCaption.style.cssText = `
                    position: fixed;
                    top: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: red;
                    color: white;
                    padding: 20px;
                    border: 5px solid yellow;
                    font-size: 20px;
                    font-weight: bold;
                    z-index: 99999;
                `;
                document.body.appendChild(testCaption);
                console.log('Direct test caption created');
                
                setTimeout(() => {
                    if (testCaption.parentNode) {
                        testCaption.parentNode.removeChild(testCaption);
                        console.log('Direct test caption removed');
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Failed to initialize animation module:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Create a simple fallback animation system
                window.treeAnimation = {
                    showCaption: function(message) {
                        console.log('Fallback caption:', message);
                        const container = document.getElementById('tree-display');
                        if (container) {
                            const caption = document.createElement('div');
                            caption.textContent = message;
                            caption.style.cssText = `
                                position: absolute;
                                top: 10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: rgba(0, 0, 0, 0.8);
                                color: white;
                                padding: 10px 20px;
                                border-radius: 20px;
                                font-size: 16px;
                                z-index: 1000;
                                animation: fadeInOut 3s ease-in-out;
                            `;
                            container.appendChild(caption);
                            setTimeout(() => {
                                if (caption.parentNode) {
                                    caption.parentNode.removeChild(caption);
                                }
                            }, 3000);
                        }
                    },
                    processServerData: function(data) {
                        console.log('Fallback processing data:', data);
                        this.showCaption('Received: ' + data.message);
                    }
                };
                console.log('Fallback animation system created');
                
                // Test the fallback system
                window.treeAnimation.showCaption('Fallback animation system is working!');
            }
            
            console.log('=== ANIMATION INITIALIZATION END ===');
            
            // Initialize communication module
            console.log('Initializing communication module...');
            window.treeCommunication = new TreeCommunication({
                onConnect: () => {
                    updateConnectionStatus(true);
                    if (window.treeUI) {
                        window.treeUI.setConnectionStatus(true);
                    }
                },
                onDisconnect: () => {
                    updateConnectionStatus(false);
                    if (window.treeUI) {
                        window.treeUI.setConnectionStatus(false);
                    }
                },
                onMessage: (data) => {
                    console.log('Received message:', data);
                    logToUI(JSON.stringify(data));
                },
                onAnimationData: (data) => {
                    if (window.treeAnimation) {
                        window.treeAnimation.processServerData(data);
                    }
                },
                onError: (error) => {
                    console.error('Connection error:', error);
                    logToUI('Error: ' + error.message);
                }
            });
            console.log('Communication module initialized:', window.treeCommunication);
            
            // Initialize UI module
            console.log('Initializing UI module...');
            window.treeUI = new TreeUI(window.treeCommunication);
            console.log('UI module initialized:', window.treeUI);
            
            // Update animation when tree type changes
            console.log('Setting up tree type change handler...');
            const treeTypeSelect = document.getElementById('tree-type');
            if (treeTypeSelect) {
                treeTypeSelect.addEventListener('change', function() {
                    console.log('Tree type changed to:', this.value);
                    if (window.treeAnimation && window.treeAnimation.setTreeType) {
                        window.treeAnimation.setTreeType(this.value);
                    }
                });
                console.log('Tree type change handler added');
            } else {
                console.error('Tree type select element not found');
            }
            
            // Test animation button
            const testAnimationBtn = document.getElementById('test-animation-btn');
            if (testAnimationBtn) {
                console.log('Test button found, adding event listener...');
                testAnimationBtn.addEventListener('click', function() {
                    console.log('Test animation button clicked!');
                    
                    // Simple test - just show an alert and create a visible element
                    const container = document.getElementById('tree-display');
                    if (container) {
                        console.log('Container found, creating test element...');
                        
                        // Clear container first
                        container.innerHTML = '';
                        
                        const testDiv = document.createElement('div');
                        testDiv.textContent = 'TEST: Animation system is working!';
                        testDiv.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: #e74c3c;
                            color: white;
                            padding: 20px;
                            border-radius: 10px;
                            font-size: 18px;
                            z-index: 1000;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        `;
                        container.appendChild(testDiv);
                        
                        console.log('Test element created and added to container');
                        
                        setTimeout(() => {
                            if (testDiv.parentNode) {
                                testDiv.parentNode.removeChild(testDiv);
                                console.log('Test element removed');
                            }
                        }, 3000);
                    } else {
                        console.error('Container not found!');
                    }
                });
                console.log('Event listener added to test button');
            } else {
                console.error('Test button not found!');
            }
        });
    </script>
</body>
</html>

